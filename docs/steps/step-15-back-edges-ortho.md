# Шаг 15: BackEdges (Ortho) — маршрут через край ряда и вход по 0.75 ширины

## Цель
Реализовать альтернативный стиль обратных рёбер с ортогональной маршрутизацией. Ребро соединяет ноду-источник и ноду-приёмник. Маршрут строго сегментами под 90° со скруглениями, с фиксированными точками входа/выхода на гранях нод.

## Правила маршрута
- **[порты]**
  - Выход из источника — строго из верхней грани, из точки на 0.75 её длины (от левого края) и сразу вертикально вверх на 20 px.
  - Вход в приёмник — строго в верхнюю грань, в точку на 0.75 её длины (от левого края). Перед входом используется треугольная стрелка, чья вершина касается верхней грани приёмника именно в точке 0.75 ширины.

- **[направление «полки»]**
  - После подъёма на 20 px от источника линия поворачивает на 90°:
    - влево — если нода-источник находится в левой половине ряда;
    - вправо — если нода-источник находится в правой половине или в центре ряда.
  - Горизонтальный сегмент («полка») продолжается до края самого широкого ряда нод расположенных выше ноды источника  + 20 px выноса за край. Нижние ряды нод в расчет не брать.

- **[подъём к уровню приёмника]**
  - У края ряда линия поворачивает на 90° вверх и продолжается до вертикали, соответствующей верхней грани приёмника (уровень по Y приёмника) + 20 px над верхом приёмника.
  - Затем поворачивает на 90° в сторону приёмника и идёт горизонтально до проекции точки входа (0.75 ширины верхней грани приёмника).
  - Далее поворачивает вниз на 90° и подходит к верхней грани стрелки, которая примыкает к ноде-приёмнику.

- **[стрелка]**
  - Стрелка треугольной формы, ориентирована вниз.
  - Вершина стрелки соприкасается с верхней гранью приёмника в точке 0.75 длины грани.
  - Контур линии должен подходить к стрелке по центру верхней грани треугольника (midpoint), а не к вершине/биссектрисе.

- **[скругления]**
  - Каждый поворот 90° выполняется со скруглением (четверть окружности) заданного радиуса.

## Изменения и интеграция
- **[новый пейнтер]** `widgets/canvas/painters/back_edges_painter_ortho.dart`
  - Отрисовывает путь по описанным правилам и стрелку в точке входа.
- **[выбор стиля]** `widgets/canvas/layers/back_edges_layer.dart`
  - Выбирает пейнтер по `RenderSettings.backEdgeStyle` и фильтрует только рёбра вверх (from.dy > to.dy).
- **[настройки]** `features/assistant/features/dialogs/settings/render_settings.dart`
  - Уже содержит `BackEdgeStyle { bezier, ortho }` и параметры орто-стиля.

## Требуемые параметры RenderSettings
- **[переключатель]** `backEdgeStyle: BackEdgeStyle.ortho`
- **[геометрия]**
  - `orthoCornerRadius` — радиус скруглений 90°.
  - `orthoVerticalClearance` — подъём от верхней грани (минимум 20 px для данного шага, допускается больше для читаемости).
  - `orthoHorizontalClearance` — резерв под разводку «полок» по X (может не использоваться на первом шаге).
  - `orthoExitOffset` — смещение точки выхода по X относительно центра верхней грани источника. Для 0.75 ширины: `orthoExitOffset = nodeSize.width * (0.75 - 0.5)`.
  - `orthoApproachOffset` — смещение точки входа по X относительно центра верхней грани приёмника. Для 0.75 ширины: `orthoApproachOffset = nodeSize.width * (0.75 - 0.5)`.
  - `orthoMinSegment` — минимальная длина сегмента для устойчивости рендера.
- **[стрелка]**
  - `arrowAttachAtEdgeMid` — стыковка линии к центру верхней грани треугольника.
  - `arrowTriangleBase`, `arrowTriangleHeight`, `arrowTriangleFilled` — параметры треугольной стрелки.

## Детализация алгоритма
- **[определение стороны ряда]**
  - Для источника вычислить его колонку в текущем ряду и сравнить с серединой ряда: «левая половина» → поворот «полки» влево, иначе вправо. Если данных о колонке нет — использовать сравнение с медианой X позиций в ряду.
- **[расчёт края ряда]**
  - Найти ширину самого широкого ряда (по positions) и вычислить его край (minX/maxX) с учётом `nodeSize.width` и горизонтальных отступов. К «полке» добавить вынос 20 px за край.
- **[переход к уровню приёмника]**
  - Вертикальный подъём от края ряда до Y приёмника минус 20 px. Далее горизонтально к оси входа приёмника, затем вниз к стрелке.
- **[скругления]**
  - В местах поворотов вставлять дуги четверти окружности радиуса `orthoCornerRadius`.

## Критерии приёмки
- **[совпадение количества]** Количество нарисованных обратных рёбер в `ortho` равно `bezier` (фильтруем вверх-edges).
- **[геометрия]** Выход из источника и вход в приёмник строго по 0.75 ширины верхней грани. Промежуточный маршрут соответствует правилам «через край ряда».
- **[стрелка]** Вершина треугольника касается верхней грани приёмника в точке 0.75 ширины. Линия подходит к центру верхней грани треугольника без зазоров.
- **[качество]** Повороты скруглены, линии читаемы, без «ломаных» изломов.

## Тест-кейсы (визуально)
- **[case 1]** Один back-edge: проверка 0.75/0.75, скруглений, стыка со стрелкой.
- **[case 2]** Источник слева и справа ряда: смена направления «полки» влево/вправо корректна.
- **[case 3]** Разные ширины рядов: «полка» корректно уходит до края самого широкого ряда + 20 px.
- **[case 4]** Несколько рёбер: количество и подключение совпадает с bezier, визуально без конфликтов.

## Замечания по реализации
- Этап 1 допускает отсутствие сложного обхода препятствий; при необходимости «полка» поднимается/опускается подбором `orthoVerticalClearance`.
- В будущем можно добавить разведение параллельных «полок» и избегание пересечений с нодами.
